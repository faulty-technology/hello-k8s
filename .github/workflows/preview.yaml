name: Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:pr-${{ github.event.pull_request.number }}

      - name: Setup Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_CLIENT_SECRET }}
          tags: tag:ci

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: "v1.28.0"

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy Preview Environment
        id: deploy
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          IMAGE_TAG: pr-${{ github.event.pull_request.number }}
          DOMAIN: faulty.technology
        run: |
          NAMESPACE="pr-${PR_NUMBER}"
          PREVIEW_URL="pr-${PR_NUMBER}-preview.${DOMAIN}"

          # Create namespace with labels
          kubectl create namespace ${NAMESPACE} --dry-run=client -o yaml | \
            kubectl label --local -f - \
              preview=true \
              pr-number="${PR_NUMBER}" \
              --overwrite -o yaml | \
            kubectl apply -f -

          # Apply resource quota for preview environments
          cat <<EOF | kubectl apply -f -
          apiVersion: v1
          kind: ResourceQuota
          metadata:
            name: preview-quota
            namespace: ${NAMESPACE}
          spec:
            hard:
              requests.cpu: "500m"
              requests.memory: "512Mi"
              limits.cpu: "1"
              limits.memory: "1Gi"
              pods: "10"
          EOF

          # Generate and apply manifests
          cat <<EOF | kubectl apply -f -
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: hello-k8s
            namespace: ${NAMESPACE}
            labels:
              app: hello-k8s
              preview: "true"
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: hello-k8s
            template:
              metadata:
                labels:
                  app: hello-k8s
              spec:
                containers:
                  - name: hello-k8s
                    image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}
                    ports:
                      - containerPort: 3000
                    env:
                      - name: NODE_ENV
                        value: "preview"
                      - name: APP_VERSION
                        value: "pr-${PR_NUMBER}"
                    resources:
                      requests:
                        memory: "128Mi"
                        cpu: "100m"
                      limits:
                        memory: "256Mi"
                        cpu: "250m"
                    livenessProbe:
                      httpGet:
                        path: /health
                        port: 3000
                      initialDelaySeconds: 10
                      periodSeconds: 10
                    readinessProbe:
                      httpGet:
                        path: /health
                        port: 3000
                      initialDelaySeconds: 5
                      periodSeconds: 5
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: hello-k8s
            namespace: ${NAMESPACE}
          spec:
            selector:
              app: hello-k8s
            ports:
              - port: 80
                targetPort: 3000
          ---
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: hello-k8s
            namespace: ${NAMESPACE}
            annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: web
          spec:
            rules:
              - host: ${PREVIEW_URL}
                http:
                  paths:
                    - path: /
                      pathType: Prefix
                      backend:
                        service:
                          name: hello-k8s
                          port:
                            number: 80
          EOF

          # Wait for deployment
          kubectl rollout status deployment/hello-k8s -n ${NAMESPACE} --timeout=120s

          # Output preview URL
          echo "preview_url=https://${PREVIEW_URL}" >> $GITHUB_OUTPUT

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const previewUrl = '${{ steps.deploy.outputs.preview_url }}';
            const body = `## ðŸš€ Preview Environment Ready!

            Your preview is deployed and available at:
            **${previewUrl}**

            This environment will be automatically deleted when the PR is closed.

            ---
            <details>
            <summary>Preview Environment Details</summary>

            - **Namespace:** pr-${{ github.event.pull_request.number }}
            - **Image:** ghcr.io/${{ github.repository }}:pr-${{ github.event.pull_request.number }}
            - **Resources:** 256Mi memory, 250m CPU (limited)

            </details>`;

            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Preview Environment')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
